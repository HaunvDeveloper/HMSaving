@{
    ViewData["Title"] = "Giao dịch";
    var culture = new System.Globalization.CultureInfo("vi-VN");
}

<div class="container mt-4 p-3">
    <h2 class="text-center text-uppercase">Danh sách Giao dịch</h2>
    <div class="mb-3 d-none d-md-block">
        <button id="btnAddDesktop" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Thêm
        </button>
    </div>
    <div class="table-responsive">
        <table id="transactionsTable" class="table table-sm table-striped  table-hover" style="width:100%;">
            <thead>
                <tr class="table-primary">
                    <th style="width:20px;"></th>
                    <th>Loại</th>
                    <th>Hũ</th>
                    <th>Ngày</th>
                    <th>Số tiền</th>
                    <th>Mô tả</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <button id="btnAddMobile"
            class="btn btn-primary rounded-circle shadow-lg d-md-none"
            style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index:1000;">
        <i class="bi bi-plus-lg fs-4"></i>
    </button>
</div>
@section Links {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        table tbody .ellipsis {
            /* display: inline-block; */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70px;
        }
    </style>
}
@section Scripts {
    <script>
        $(document).ready(function () {
            var table = $('#transactionsTable').DataTable({
                "ajax": {
                    "url": '@Url.Action("GetTransactions", "Transaction")',
                    "type": 'GET',
                    "datatype": 'json'
                },
                "columns": [
                    {
                        "className": 'details-control text-center ',
                        "orderable": false,
                        "data": null,
                        "defaultContent": '<div style="width:20px;height:20px;background-color:var(--bs-primary);border-radius:50%;border:1px solid black;cursor:pointer;"><i class="bi bi-plus-lg"></i></div>',
                        "width": '30px'
                    },
                    { "data": 'type' },
                    { "data": 'jarNames', "className" : 'ellipsis' },
                    {
                        "data": 'date',
                        "render": function (data) {
                            var date = new Date(data);
                            return date.toLocaleDateString("vi-VN");
                        }
                    },
                    {
                        "data": 'amount',
                        "render": function (data, type, row) {
                            if (row.type === "Chi Tiêu") {
                                data = -data; // Đổi dấu nếu là Chi Tiêu
                            }
                            // Thêm màu cho số tiền
                            var colorClass = row.type === "Thu Nhập" ? "text-success" : "text-danger";
                            return `<span class="${colorClass}">${parseFloat(data).toLocaleString('vi-VN')} VNĐ</span>`;
                        },
                        "className": 'text-end'
                    },
                    { "data": 'description' },
                    {
                        "data" : "id",
                        "render": function (data, type, row) {
                            var urlEdit = row.type === "Thu Nhập" ?
                                `@Url.Action("EditIncome", "Transaction")/${data}` :
                                `@Url.Action("EditExpense", "Transaction")/${data}`;

                            var urlDelete = row.type === "Thu Nhập" ?
                                `@Url.Action("DeleteIncome", "Transaction")/${data}` :
                                `@Url.Action("DeleteExpense", "Transaction")/${data}`;
                            return `<div class="text-end">
                                        <a href="${urlEdit}" class="btn btn-sm btn-warning me-1" title="Chỉnh sửa">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <a href="#" data-url="${urlDelete}" class="btn-delete btn btn-sm btn-danger" title="Xóa">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>`;
                        },
                    }
                    
                ],
                "order": [[2, 'desc']],
                "language": {
                    "url": '//cdn.datatables.net/plug-ins/1.13.4/i18n/vi.json'
                }
            });

            // Add event listener for opening and closing details
            $('#transactionsTable tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                    // Close
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    // Open
                    var data = row.data();
                    if (data.type === "Thu Nhập" && data.allocations && data.allocations.length > 0) {
                        var html = '<table class="table table-sm table-bordered mb-0">';
                        html += '<thead><tr class="table-info"><th>Hũ</th><th>Số tiền</th></tr></thead><tbody>';
                        data.allocations.forEach(function (alloc) {
                            html += '<tr><td>' + alloc.jarName + '</td><td>' + parseFloat(alloc.amount).toLocaleString("vi-VN") + ' VNĐ</td></tr>';
                        });
                        html += '</tbody></table>';
                        row.child(html).show();
                    } else {
                        row.child('<em>Không có dữ liệu chi tiết.</em>').show();
                    }
                    tr.addClass('shown');
                }
            });


            // Nút Thêm desktop
            $('#btnAddDesktop').click(function () {
                showAddOptions();
            });

            // Nút Thêm mobile
            $('#btnAddMobile').click(function () {
                showAddOptions();
            });

            // SweetAlert2 chọn thêm loại giao dịch
            function showAddOptions() {
                Swal.fire({
                    title: 'Bạn muốn thêm gì?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Thêm Thu Nhập',
                    cancelButtonText: 'Thêm Chi Tiêu',
                    reverseButtons: true,
                    customClass: {
                        confirmButton: 'btn btn-success',
                        cancelButton: 'btn btn-danger me-3'
                    },
                    buttonsStyling: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("CreateIncome", "Transaction")';
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        window.location.href = '@Url.Action("CreateExpense", "Transaction")';
                    }
                });
            }

            $(document).on('click', '.btn-delete', function(){
                var url = $(this).data('url');
                Swal.fire({
                    title: 'Bạn có chắc chắn muốn xóa giao dịch này?',
                    text: "Hành động này không thể hoàn tác!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy',
                    customClass: {
                        confirmButton: 'btn btn-danger',
                        cancelButton: 'btn btn-secondary'
                    },
                    buttonsStyling: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: url,
                            type: 'POST',
                            success: function (res) {
                                if(res.status)
                                {
                                    showToast('success', 'Xóa giao dịch thành công!');
                                    table.ajax.reload();
                                }
                                else{
                                    Swal.fire('Lỗi!', 'Không thể xóa giao dịch.', 'error');
                                }
                            },
                            error: function () {
                                Swal.fire('Lỗi!', 'Không thể xóa giao dịch.', 'error');
                            }
                        });
                    }
                });
            });
        });
    </script>
}
