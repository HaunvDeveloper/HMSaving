@model List<EatingDayStat>
@{
    var culture = new System.Globalization.CultureInfo("vi-VN");
    var today = DateTime.Today;

    var daysInMonth = Model.OrderBy(x => x.Date).ToList();
    var firstDayOfMonth = daysInMonth.FirstOrDefault()?.Date ?? DateTime.Today;
    var totalDays = DateTime.DaysInMonth(firstDayOfMonth.Year, firstDayOfMonth.Month);
    var calendar = new List<List<EatingDayStat?>>(); // List tuần

    int dayOffset = ((int)firstDayOfMonth.DayOfWeek + 6) % 7; // Đưa Chủ nhật (0) về cuối
    var currentWeek = new List<EatingDayStat?>();

    // Bổ sung ngày trắng đầu tuần
    for (int i = 0; i < dayOffset; i++) currentWeek.Add(null);

    foreach (var day in daysInMonth)
    {
        currentWeek.Add(day);
        if (currentWeek.Count == 7)
        {
            calendar.Add(currentWeek);
            currentWeek = new List<EatingDayStat?>();
        }
    }

    // Bổ sung ngày trắng cuối tháng
    if (currentWeek.Count > 0)
    {
        while (currentWeek.Count < 7) currentWeek.Add(null);
        calendar.Add(currentWeek);
    }

    var avergagePerDay = Model.Select(x => x.AveragePerDay).FirstOrDefault();
    var totalRevenue = ViewBag.TotalEatingMoney as decimal?;
    var totalCost = Model.Select(x => x.SpentAmount).Sum();
    var remaining = totalRevenue.HasValue ? totalRevenue.Value - totalCost : 0m;

    var isDaynInMonth = Model.Any(x => x.Date.Date == today);
    var avgToDay = Model.FirstOrDefault(x => x.Date.Date == today)?.AveragePerDay ?? 0m;
    var costToday = Model.FirstOrDefault(x => x.Date.Date == today)?.SpentAmount ?? 0m;
    var remainingToday = avgToDay - costToday;
}
<div class="container p-4">
    <!-- Tổng trong tháng -->
    <div class="bg-light bg-opacity-50 rounded p-3 mb-4 border-start border-4 border-primary">
        <h5 class="mb-3 text-primary fw-bold"><i class="bi bi-calendar3"></i> Tổng kết tháng</h5>
        <div class="row g-3">
            <!-- Tổng tiền ăn -->
            <div class="col-md-4">
                <div class="card text-white bg-success shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Tổng tiền ăn</h6>
                        <h4 class="card-text fs-4">@totalRevenue?.ToString("C", culture)</h4>
                    </div>
                </div>
            </div>
            <!-- Tổng chi tiêu -->
            <div class="col-md-4">
                <div class="card text-white bg-danger shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Tổng chi tiêu</h6>
                        <h4 class="card-text fs-4">@totalCost.ToString("C", culture)</h4>
                    </div>
                </div>
            </div>
            <!-- Còn lại -->
            <div class="col-md-4">
                <div class="card text-white @(remaining >= 0 ? "bg-primary" : "bg-warning") shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Còn lại</h6>
                        <h4 class="card-text fs-4">@remaining.ToString("C", culture)</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (isDaynInMonth)
    {
        <!-- Tổng trong ngày -->
        <div class="bg-light bg-opacity-50 rounded p-3 border-start border-4 border-success">
            <h5 class="mb-3 text-success fw-bold"><i class="bi bi-clock"></i> Tổng kết hôm nay</h5>
            <div class="row g-3">
                <!-- Tiền ăn hôm nay -->
                <div class="col-md-4">
                    <div class="card text-white bg-success shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title">Tiền ăn hôm nay</h6>
                            <h4 class="card-text fs-4">@avgToDay.ToString("C", culture)</h4>
                        </div>
                    </div>
                </div>
                <!-- Chi tiêu hôm nay -->
                <div class="col-md-4">
                    <div class="card text-white bg-danger shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title">Chi tiêu hôm nay</h6>
                            <h4 class="card-text fs-4">@costToday.ToString("C", culture)</h4>
                        </div>
                    </div>
                </div>
                <!-- Còn lại hôm nay -->
                <div class="col-md-4">
                    <div class="card text-white @(remainingToday >= 0 ? "bg-primary" : "bg-warning") shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title">Còn lại hôm nay</h6>
                            <h4 class="card-text fs-4">@remainingToday.ToString("C", culture)</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    
</div>


<div class="container px-1">
    <div class="row fw-bold text-center mb-1 small">
        <div class="col text-truncate">T2</div>
        <div class="col text-truncate">T3</div>
        <div class="col text-truncate">T4</div>
        <div class="col text-truncate">T5</div>
        <div class="col text-truncate">T6</div>
        <div class="col text-truncate">T7</div>
        <div class="col text-truncate">CN</div>
    </div>

    @foreach (var week in calendar)
    {
        <div class="row g-1 mb-1">
            @foreach (var day in week)
            {
                <div class="col col-sm calendar-card">
                    @if (day != null)
                    {
                        var isToday = day.Date.Date == today;
                        var borderClass = day.Difference > 0 ? "success" : "danger";
                        var highlightClass = isToday ? "bg-info bg-opacity-25 border-3" : "";

                        <div class="card shadow-sm border-@borderClass @highlightClass h-100 calendar-day-card user-select-none"
                             style="cursor:pointer;"
                             data-date="@day.Date.ToString("yyyy-MM-dd")"
                             data-average="@day.AveragePerDay"
                             data-spent="@day.SpentAmount"
                             data-difference="@day.Difference">

                            <div class="card-body p-1">
                                <h6 class="text-@borderClass date-name fw-bold">
                                    <span class="hidden-sm">Ngày</span> @day.Date.Day
                                </h6>
                                <div>
                                    <div class="hidden-sm">
                                        <strong>TB:</strong> 
                                        <span class="text-primary fw-bold">@day.AveragePerDay.ToString("C0", culture)</span>
                                    </div>
                                    <div class="hidden-sm"><strong>Chi:</strong> <span class="text-danger fw-bold">@day.SpentAmount.ToString("C0", culture)</span></div>
                                    <div>
                                        <strong class="hidden-sm">Còn:</strong>
                                        <span class="text-@(day.Difference > 0 ? "success  fw-bold" : "danger fw-bold") diff-amount" data-amount="@day.Difference">
                                            @(day.Difference >= 0 ? "+" : "-")@Math.Abs(day.Difference).ToString("C0", culture)
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

                                        