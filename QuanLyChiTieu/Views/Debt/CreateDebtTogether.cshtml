@model CreateDebtTogetherViewModel
@{
    ViewData["Title"] = "Chia Công Nợ Chung";
    var partners = ViewBag.Partners as List<Partner>;
}

<div class="container mt-4 p-3">
    <h2>Chia Công Nợ Chung</h2>
    <form asp-action="CreateDebtTogether" method="post" class="needs-validation" novalidate>
        <div class="mb-3">
            <label class="form-label">Loại giao dịch</label><br />
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="InDebt" value="true" />
                <label for="InDebt" class="form-check-label">Nhận tiền</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="InDebt" value="false" />
                <label for="InDebt" class="form-check-label">Trả tiền</label>
            </div>
        </div>
        <div class="mb-3">
            <label for="PayerPartnerId" class="form-label">Người trả tiền</label>
            <select asp-for="PayerPartnerId" class="form-select">
                <option value="">-- Tôi trả --</option>
                @foreach (var partner in partners)
                {
                    <option value="@partner.PartnerId">@partner.PartnerName</option>
                }
            </select>
        </div>

        <div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
            @for (int i = 0; i < Model.Debts.Count; i++)
            {
                <div class="col">
                    <div class="card h-100">
                        <div class="card-header bg-success fw-bold">
                            @Model.Debts[i].PartnerName
                        </div>
                        <div class="card-body">
                            <input type="hidden" asp-for="Debts[@i].PartnerId" />
                            <input type="hidden" asp-for="Debts[@i].PartnerName" />
                            <label class="form-label">Số tiền</label>
                            <div class="input-group">
                                <input asp-for="Debts[@i].Amount" type="text" value="" class="form-control text-end amount-input" placeholder="0" />
                                <span class="input-group-text">.000 VNĐ</span>
                            </div>
                            <!--Bỏ trống nếu không có-->
                            <span href="#" class="text-dark fst-italic mt-2">Bỏ trống nếu không có</span>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="mb-3">
            <label asp-for="DebtDate" class="form-label">Ngày ghi nợ</label>
            <input asp-for="DebtDate" type="date" class="form-control" />
        </div>

        <div class="mb-3">
            <label asp-for="Description" class="form-label">Ghi chú</label>
            <textarea asp-for="Description" class="form-control"></textarea>
        </div>

        <!-- ViewBag Error Message Alert -->
        @if (ViewBag.ErrorMessage != null)
        {
            <div class="alert alert-danger" role="alert">
                @ViewBag.ErrorMessage
            </div>
        }


        <button type="submit" class="btn btn-primary">Lưu</button>
        <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
    </form>
</div>

@section Scripts {
    <script>
        document.querySelectorAll(".amount-input").forEach(input => {
            input.addEventListener("input", function () {
                let value = this.value.replace(/,/g, "").replace(/[^\d]/g, "");
                if (value) {
                    this.value = Number(value).toLocaleString("en-US");
                    this.classList.add("is-valid");
                } else {
                    this.value = "";
                    this.classList.remove("is-valid");
                }
                // add valid class into input
            });

            // Trigger formatting on load
            input.dispatchEvent(new Event("input"));
        });

        // hide PayerPartnerId when InDebt=true
        document.querySelectorAll('input[name="InDebt"]').forEach(input => {
            input.addEventListener('change', function () {
                const payerSelect = document.getElementById('PayerPartnerId');
                if (this.value === 'true') {
                    payerSelect.disabled = true;
                    payerSelect.value = ""; // Reset value
                    //hide parent div
                    payerSelect.classList.add('d-none');


                } else {
                    payerSelect.disabled = false;
                    //show
                    payerSelect.classList.remove('d-none');
                }
            });
        });

        // Validate and clean comma before submit
        (() => {
            'use strict';
            const form = document.querySelector('form');
            form.addEventListener('submit', event => {
                document.querySelectorAll(".amount-input").forEach(input => {
                    input.value = input.value.replace(/,/g, "");
                });
            }, false);
        })();
    </script>
}
