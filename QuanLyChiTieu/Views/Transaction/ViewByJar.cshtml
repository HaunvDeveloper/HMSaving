@model QuanLyChiTieu.Models.ExpenseJar
@{
    ViewData["Title"] = "Giao dịch";
    var culture = new System.Globalization.CultureInfo("vi-VN");
    var fromDate = ViewBag.FromDate as DateOnly?;
    var toDate = ViewBag.ToDate as DateOnly?;
}

<div class="container mt-4 p-3">
    <h2 class="text-center text-uppercase">
        Giao dịch  <strong class="text-danger">HŨ @Model.JarName</strong> 
        @if (fromDate != null && toDate != null)
        {
            if(fromDate != toDate)
            {
                <span class="text-muted">từ @fromDate.Value.ToString("dd/MM/yyyy") đến @toDate.Value.ToString("dd/MM/yyyy")</span>

            }
            else
            {
                <span class="text-muted">NGÀY @fromDate.Value.ToString("dd/MM/yyyy")</span>
            }
        }
    </h2>
    <div class="mb-3 d-none d-md-block">
        <button id="btnAddDesktop" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Thêm
        </button>
    </div>
    <div class="table-responsive">
        <table id="transactionsTable" class="table table-sm table-striped table-bordered table-hover" style="width:100%; table-layout:fixed;">
            <thead>
                <tr class="table-primary">
                    <th>Loại</th>
                    <th>Ngày</th>
                    <th>Số tiền</th>
                    <th>Mô tả</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button id="btnAddMobile"
            class="btn btn-primary rounded-circle shadow-lg d-md-none"
            style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index:1000;">
        <i class="bi bi-plus-lg fs-4"></i>
    </button>
</div>
@section Links {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
}
@section Scripts {
    <script>
        $(document).ready(function () {
            $('#transactionsTable').DataTable({
                "processing": true,
                "searching": true,
                "processing": true,
                "lengthMenu": [5, 10, 25, 50, 100],
                "pageLength": 25,
                "ajax": {
                    "url": "/Transaction/GetTransactionByJar",
                    "type": "GET",
                    "data": { 
                        jarId: @(Model.JarId),
                        fromDate: getParamFromCurrentUrl('fromDate'),
                        toDate: getParamFromCurrentUrl('toDate')
                    }
                },
                "columns": [
                    { "data": "type" },
                    {
                        "data": "date",
                        "render": function (data) {
                            var date = new Date(data);
                            return date.toLocaleDateString("vi-VN");
                        }
                    },
                    {
                        "data": "amount",
                        "render": function (data, type, row) {
                            if (row.type === "Chi Tiêu") {
                                data = -data; // Đổi dấu nếu là Chi Tiêu
                            }
                            // Thêm màu cho số tiền
                            var colorClass = row.type === "Thu Nhập" ? "text-success" : "text-danger";
                            return `<span class="${colorClass}">${parseFloat(data).toLocaleString('vi-VN')} VNĐ</span>`;
                        },
                        "className": "text-end"
                    },
                    { "data": "description" }
                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/vi.json"
                }
            });



            // Nút Thêm desktop
            $('#btnAddDesktop').click(function () {
                showAddOptions();
            });

            // Nút Thêm mobile
            $('#btnAddMobile').click(function () {
                showAddOptions();
            });

            // SweetAlert2 chọn thêm loại giao dịch
            function showAddOptions() {
                Swal.fire({
                    title: 'Bạn muốn thêm gì?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Thêm Thu Nhập',
                    cancelButtonText: 'Thêm Chi Tiêu',
                    reverseButtons: true,
                    customClass: {
                        confirmButton: 'btn btn-success',
                        cancelButton: 'btn btn-danger me-3'
                    },
                    buttonsStyling: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("CreateIncome", "Transaction")';
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        window.location.href = '@Url.Action("CreateExpense", "Transaction", new{jarId=Model.JarId})';
                    }
                });
            }
        });
    </script>
}
